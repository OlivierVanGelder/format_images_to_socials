name: Format media for socials

on:
  workflow_dispatch:
    inputs:
      media_url:
        description: "Directe URL naar media (jpg, png, mp4, mov). Moet zonder login te downloaden zijn."
        required: true
        type: string
      mode:
        description: "Bij snijden (crop) of vullen met randen (pad)"
        required: true
        default: crop
        type: choice
        options:
          - crop
          - pad
      focal_x:
        description: "Focuspunt horizontaal 0.0 tot 1.0 (0 links, 0.5 midden, 1 rechts)"
        required: false
        default: "0.5"
        type: string
      focal_y:
        description: "Focuspunt verticaal 0.0 tot 1.0 (0 boven, 0.5 midden, 1 onder)"
        required: false
        default: "0.5"
        type: string
      supabase_folder:
        description: "Map in de bucket, bijvoorbeeld formatted of formatted/campaign_01"
        required: false
        default: "formatted"
        type: string

jobs:
  format:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Format media (all platforms)
        env:
          MEDIA_URL: ${{ inputs.media_url }}
          MODE: ${{ inputs.mode }}
          FOCAL_X: ${{ inputs.focal_x }}
          FOCAL_Y: ${{ inputs.focal_y }}
        run: |
          python scripts/format_media.py \
            --media-url "$MEDIA_URL" \
            --mode "$MODE" \
            --focal-x "$FOCAL_X" \
            --focal-y "$FOCAL_Y"

      - name: Upload outputs to Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_BUCKET: ${{ secrets.SUPABASE_BUCKET }}
          SUPABASE_FOLDER: ${{ inputs.supabase_folder }}
          RUN_ID: ${{ github.run_id }}
        run: |
          set -euo pipefail

          if [ -z "${SUPABASE_URL:-}" ] || [ -z "${SUPABASE_KEY:-}" ] || [ -z "${SUPABASE_BUCKET:-}" ]; then
            echo "Repo secrets ontbreken: SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, SUPABASE_BUCKET"
            exit 1
          fi

          if [ ! -d out ]; then
            echo "Map out/ ontbreekt"
            exit 1
          fi

          shopt -s nullglob
          files=(out/*)
          if [ ${#files[@]} -eq 0 ]; then
            echo "Geen output bestanden gevonden"
            exit 1
          fi

          folder="${SUPABASE_FOLDER%/}"
          if [ -z "$folder" ]; then
            folder="formatted"
          fi

          manifest_path="out/manifest.json"
          echo "{" > "$manifest_path"
          echo "  \"bucket\": \"${SUPABASE_BUCKET}\"," >> "$manifest_path"
          echo "  \"folder\": \"${folder}\"," >> "$manifest_path"
          echo "  \"run_id\": \"${RUN_ID}\"," >> "$manifest_path"
          echo "  \"files\": [" >> "$manifest_path"

          first=true
          for f in "${files[@]}"; do
            name="$(basename "$f")"

            content_type="application/octet-stream"
            case "$name" in
              *.jpg|*.jpeg) content_type="image/jpeg" ;;
              *.png) content_type="image/png" ;;
              *.webp) content_type="image/webp" ;;
              *.mp4) content_type="video/mp4" ;;
              *.mov) content_type="video/quicktime" ;;
              *.m4v) content_type="video/x-m4v" ;;
              *.webm) content_type="video/webm" ;;
            esac

            object_path="${folder}/${name}"

            # URL encode object_path, maar laat slashes staan
            encoded_path="$(python -c "import urllib.parse; print(urllib.parse.quote('${object_path}', safe='/'))")"

            upload_url="${SUPABASE_URL}/storage/v1/object/${SUPABASE_BUCKET}/${encoded_path}?upsert=true"

            echo "Upload: ${object_path} (${content_type})"
            curl -sS -X POST "$upload_url" \
              -H "Authorization: Bearer ${SUPABASE_KEY}" \
              -H "apikey: ${SUPABASE_KEY}" \
              -H "Content-Type: ${content_type}" \
              --data-binary @"${f}" \
              -o /tmp/supabase_upload_resp.txt

            public_url="${SUPABASE_URL}/storage/v1/object/public/${SUPABASE_BUCKET}/${encoded_path}"

            if [ "$first" = true ]; then
              first=false
            else
              echo "    ," >> "$manifest_path"
            fi

            echo "    {\"filename\":\"${name}\",\"path\":\"${object_path}\",\"public_url\":\"${public_url}\"}" >> "$manifest_path"
          done

          echo "" >> "$manifest_path"
          echo "  ]" >> "$manifest_path"
          echo "}" >> "$manifest_path"

          echo "Manifest geschreven naar ${manifest_path}"
          cat "$manifest_path"

      - name: Upload artifact (backup)
        uses: actions/upload-artifact@v4
        with:
          name: formatted-and-manifest
          path: out/
          if-no-files-found: error